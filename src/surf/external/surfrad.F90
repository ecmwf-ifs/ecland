SUBROUTINE SURFRAD(YDSURF,KDD,KMM,KMON,KSECO,&
 & KIDIA,KFDIA,KLON,KTILES,KSW,KLW,&
 & LDNH,&
 & PALBF,PALBICEF,PTVH,&
 & PALCOEFF,PCUR,PCVH,&
 & PASN,PMU0,PTS,PWND,&
 & PWS1,KSOTY,PFRTI,PHLICE,PTLICE,&  
 & PALBD,PALBP,PALB,&
 & PSPECTRALEMISS,PEMIT,&
 & PALBTI,PCCNL,PCCNO, &
 & LNEMOLIMALB)

USE PARKIND1, ONLY : JPIM, JPRB
USE ISO_C_BINDING

!ifndef INTERFACE

USE YOMHOOK,  ONLY : LHOOK, DR_HOOK, JPHOOK
USE YOS_SURF, ONLY : TSURF, GET_SURF

USE ABORT_SURF_MOD
USE SURFRAD_CTL_MOD

!endif INTERFACE

! (C) Copyright 1991- ECMWF.
!
! This software is licensed under the terms of the Apache Licence Version 2.0
! which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.
! In applying this licence, ECMWF does not waive the privileges and immunities
! granted to it by virtue of its status as an intergovernmental organisation
! nor does it submit to any jurisdiction.

!**** *SURFRAD - COMPUTES RADIATIVE PROPERTIES OF SURFACE

!     PURPOSE.
!     --------

!**   INTERFACE.
!     ----------
!        CALL *SURFRAD* FROM *CALLPAR*

!        EXPLICIT ARGUMENTS :
!        --------------------
!     ==== INPUTS ===
! KDD,KMM : final date
! KMON   : length of the 12 months
! KSECO  : Number of seconds since 00 UTC on the initial day of the forecast
! LDNH   : LOGICAL  : .TRUE. FOR Northern Hemisphere
! PALBF  : REAL     : FIXED BACKGROUND SURFACE SHORTWAVE ALBEDO
! PALBICEF REAL     : FIXED SEA-ICE ALBEDO (FROM COUPLER)
! PTVH   : REAL     : DOMINANT HIGH VEGETATION TYPE
! PALCOEFF : REAL   : MODIS albedo coefficients
! PCUR   : REAL     : URBAN COVER (PASSIVE)
! PCVH   : REAL     : HIGH VEGETATION COVER
! PASN   : REAL     : ALBEDO OF EXPOSED SNOW (TYPE 5)
! PMU0   : REAL     : COSINE OF SOLAR ZENITH ANGLE
! PTS    : REAL     : SURFACE TEMPERATURE
! PWND   : REAL     : WIND INTENSITY AT LOWEST LEVEL
! PWS1   : REAL     : TOP LAYER SOIL MOISTURE CONTENT
! KSOTY  : INTEGER  : SOIL TYPE                           (1-7)
! PFRTI  : REAL     : TILE FRACTIONS                      (0-1)
!            1 : WATER                  5 : SNOW ON LOW-VEG+BARE-SOIL
!            2 : ICE                    6 : DRY SNOW-FREE HIGH-VEG
!            3 : WET SKIN               7 : SNOW UNDER HIGH-VEG
!            4 : DRY SNOW-FREE LOW-VEG  8 : BARE SOIL
! PHLICE : REAL     : LAKE ICE THICKNESS (m)
! PTLICE : REAL     : LAKE ICE TEMPERATURE (K)

!     ==== OUTPUTS ===
! PALBD  : REAL     : SURFACE ALBEDO FOR DIFFUSE RADIATION
! PALBP  : REAL     : SURFACE ALBEDO FOR PARALLEL RADIATION
! PALB   : REAL     : AVERAGE SW ALBEDO (DIAGNOSTIC ONLY)
! PSPECTRALEMISS : REAL : SURFACE LONGWAVE SPECTRAL EMISSIVITY
! PEMIT  : REAL     : BROADBAND SURFACE LONGWAVE EMISSIVITY
! PALBTI : REAL     : BROADBAND ALBEDO FOR TILE FRACTIONS
! PCCNL  : REAL     : CCN CONCENTRATION OVER LAND
! PCCNO  : REAL     : CCN CONCENTRATION OVER OCEAN

!     ==== OUTPUTS ===

!        IMPLICIT ARGUMENTS :   NONE
!        --------------------

!     METHOD.
!     -------

!     EXTERNALS.
!     ----------
!          NONE

!     REFERENCE.
!     ----------

!        SEE RADIATION'S PART OF THE MODEL'S DOCUMENTATION AND
!        ECMWF RESEARCH DEPARTMENT DOCUMENTATION OF THE "I.F.S"

!     AUTHOR.
!     -------
!     J.-J. MORCRETTE  E.C.M.W.F.    91/03/15

!     MODIFICATIONS.
!     --------------
!     J.-J. MORCRETTE  ECMWF 94/11/15  DIRECT/DIFFUSE ALBEDOS
!     J.-J. MORCRETTE 96/06/07  moisture dep. emissiv. / spectral alb.  
!     PJANSSEN/JJMORCRETTE ECMWF     96/11/07  WIND DEPENDENT SEA ALBEDO
!     PViterbo         ECMWF 99/03/03  Albedo for tile fractions
!     J.-J. Morcrette ECMWF 00/10/24 Spectral albedo for all surfaces
!     JJMorcrette     01-10-08  CCNs concentration over ocean
!     J.F. Estrade *ECMWF* 03-10-01 move in surf vob
!     M.Hamrud      01-Oct-2003 CY28 Cleaning
!     G.Balsamo     03-Jul-2006 Add soil type
!     JJMorcrette ECMWF 2006-05-10 MODIS albedo
!     E.Dutra/G.Balsamo 2008-05-01 Add lake tile 
!     Linus Magnusson   10-09-28 Sea-ice 
!     R. Hogan      15-Jan-2019  6-component MODIS albedo
!     R. Hogan      23-Jan-2019  Spectral longwave emissivity in NLWEMISS intervals
!-----------------------------------------------------------------------

IMPLICIT NONE
! Declaration of arguments

TYPE(C_PTR)       ,INTENT(IN)    :: YDSURF
INTEGER(KIND=JPIM),INTENT(IN)    :: KDD 
INTEGER(KIND=JPIM),INTENT(IN)    :: KMM 
INTEGER(KIND=JPIM),INTENT(IN)    :: KMON(:) 
INTEGER(KIND=JPIM),INTENT(IN)    :: KSECO
INTEGER(KIND=JPIM),INTENT(IN)    :: KIDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KFDIA 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLON 
INTEGER(KIND=JPIM),INTENT(IN)    :: KTILES 
INTEGER(KIND=JPIM),INTENT(IN)    :: KSW 
INTEGER(KIND=JPIM),INTENT(IN)    :: KLW
INTEGER(KIND=JPIM),INTENT(IN)    :: KSOTY(:) 
LOGICAL           ,INTENT(IN)    :: LDNH(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PALBF(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PALBICEF(:)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PTVH(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PALCOEFF(:,:)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PCUR(:)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PCVH(:)
REAL(KIND=JPRB)   ,INTENT(IN)    :: PASN(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PMU0(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PTS(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWND(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PWS1(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PFRTI(:,:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PHLICE(:) 
REAL(KIND=JPRB)   ,INTENT(IN)    :: PTLICE(:)
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PALBD(:,:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PALBP(:,:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PALB(:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PSPECTRALEMISS(:,:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PEMIT(:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PALBTI(:,:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCCNL(:) 
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PCCNO(:) 
LOGICAL           ,INTENT(IN)    :: LNEMOLIMALB

!ifndef INTERFACE

TYPE(TSURF), POINTER :: YSURF
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('SURFRAD',0,ZHOOK_HANDLE)

YSURF => GET_SURF(YDSURF)

IF(UBOUND(PALBF,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PALBF TOO SHORT!')
ENDIF

IF(UBOUND(PALBICEF,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PALBICEF TOO SHORT!')
ENDIF

IF(UBOUND(PTVH,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PTVH TOO SHORT!')
ENDIF

IF(UBOUND(PALCOEFF,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PALCOEFF TOO SHORT!')
ENDIF

IF(UBOUND(PCUR,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PCUR TOO SHORT!')
ENDIF

IF(UBOUND(PCVH,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PCVH TOO SHORT!')
ENDIF


IF(UBOUND(PASN,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PASN TOO SHORT!')
ENDIF

IF(UBOUND(PMU0,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PMU0 TOO SHORT!')
ENDIF

IF(UBOUND(PTS,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PTS TOO SHORT!')
ENDIF

IF(UBOUND(PWND,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PWND TOO SHORT!')
ENDIF

IF(UBOUND(PWS1,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PWS1 TOO SHORT!')
ENDIF

IF(UBOUND(PALB,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PALB TOO SHORT!')
ENDIF

IF(UBOUND(PSPECTRALEMISS,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PSPECTRALEMISS TOO SHORT!')
ENDIF
IF(UBOUND(PSPECTRALEMISS,2) < KLW) THEN
  CALL ABORT_SURF('SURFRAD: PSPECTRALEMISS TOO FEW SPECTRAL INTERVALS!')
ENDIF

IF(UBOUND(PEMIT,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PEMIT TOO SHORT!')
ENDIF

IF(UBOUND(PCCNL,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PCCNL TOO SHORT!')
ENDIF

IF(UBOUND(PCCNO,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: PCCNO TOO SHORT!')
ENDIF

IF(UBOUND(LDNH,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: LDNH TOO SHORT!')
ENDIF

IF(UBOUND(KSOTY,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF KSOTY TOO SHORT!')
ENDIF

IF(UBOUND(PFRTI,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF PFRTI TOO SHORT!')
ENDIF

IF(UBOUND(PFRTI,2) < KTILES) THEN
  CALL ABORT_SURF('SURFRAD: SECOND DIMENSION OF PFRTI TOO SHORT!')
ENDIF

IF(UBOUND(PALBTI,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF PALBTI TOO SHORT!')
ENDIF

IF(UBOUND(PALBTI,2) < KTILES) THEN
  CALL ABORT_SURF('SURFRAD: SECOND DIMENSION OF PALBTI TOO SHORT!')
ENDIF

IF(UBOUND(PALBD,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF PALBD TOO SHORT!')
ENDIF

IF(UBOUND(PALBD,2) < KSW) THEN
  CALL ABORT_SURF('SURFRAD: SECOND DIMENSION OF PALBD TOO SHORT!')
ENDIF

IF(UBOUND(PALBP,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF PALBP TOO SHORT!')
ENDIF

IF(UBOUND(PALBP,2) < KSW) THEN
  CALL ABORT_SURF('SURFRAD: SECOND DIMENSION OF PALBP TOO SHORT!')
ENDIF

IF(UBOUND(PHLICE,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF PHLICE TOO SHORT!')
ENDIF

IF(UBOUND(PTLICE,1) < KLON) THEN
  CALL ABORT_SURF('SURFRAD: FIRST DIMENSION OF PTLICE TOO SHORT!')
ENDIF

CALL SURFRAD_CTL (KDD,KMM,KMON,KSECO,&
 & KIDIA,KFDIA,KLON,KTILES,KSW,KLW,&
 & LDNH,&
 & PALBF,PALBICEF, PTVH,&
 & PALCOEFF,PCUR,PCVH,&
 & PASN,PMU0,PTS,PWND,&
 & PWS1,KSOTY,PFRTI,PHLICE,PTLICE,&   
 & YSURF%YCST,YSURF%YLW,YSURF%YSW,YSURF%YRAD,YSURF%YRDI,YSURF%YSOIL,YSURF%YFLAKE,&
 & YSURF%YURB,PALBD,PALBP,PALB,&
 & PSPECTRALEMISS,PEMIT,&
 & PALBTI,PCCNL,PCCNO,&
 & LNEMOLIMALB)
IF (LHOOK) CALL DR_HOOK('SURFRAD',1,ZHOOK_HANDLE)

!endif INTERFACE

!     ------------------------------------------------------------------

END SUBROUTINE SURFRAD
